#!/bin/bash

TOGGLE_STATE_FILE="/run/user/$UID/rofi_toggled_menu.state"

REQUESTED="${1:-drun}"
RUNNING_PID=$(pgrep -x rofi)
LAST_TOGGLED=$(cat "$TOGGLE_STATE_FILE" 2>/dev/null)

# If a rofi window is open AND the user is requesting the SAME menu,
# then it's a toggle-off command. We kill rofi and exit.
if [[ -n "$RUNNING_PID" && "$REQUESTED" == "$LAST_TOGGLED" ]]; then
  pkill -x rofi
  rm -f "$TOGGLE_STATE_FILE"
  exit 0
fi

# If we are here, it means we need to launch a rofi menu.
# This happens if:
#   1. No rofi instance is running.
#   2. A rofi instance IS running, but the user requested a DIFFERENT menu.
if [[ -n "$RUNNING_PID" ]]; then
  pkill -x rofi
  # Give it a moment to die to avoid race conditions
  sleep 0.1
fi


settings=()
case "${1}" in
  powermenu)
    settings=(
      "-show"
      "powermenu"
      "-modi"
      "powermenu:power-menu"
      "-theme-str"
      'window { width: 250; } mainbox { children: [listview]; } listview { margin: 0; } element { children: [element-text]; }'
    )
    shift 1
    ;;
  themes)
    settings=(
      "-show"
      "themes"
      "-modi"
      "themes:themes-menu"
      "-theme-str"
      'window { width: 280; } mainbox { children: [listview]; } listview { margin: 0; } element { children: [element-text]; }'
    )
    shift 1
    ;;
  windows)
    settings=(
      "-show"
      "window"
      "-window-format"
      "{c} - {t}"
      "-theme-str"
      'window { width: 50%; } mainbox { children: [listview]; } listview { margin: 0; }'
    )
    ;;
  *)
    settings=(
      "-show"
      "drun"
      "-theme-str"
      'window { width: 600; } entry { placeholder: "Launch application"; }'
    )
    ;;
esac

uwsm app -- rofi "${settings[@]}" "$@" >/dev/null 2>&1 &

# IMPORTANT: Save the currently toggled menu.
echo "$REQUESTED" > "$TOGGLE_STATE_FILE"