#!/bin/bash

# Original reference https://github.com/basecamp/omarchy/blob/dev/bin/omarchy-theme-menu
# ======================================================================================
# Based on Omarchy script: omarchy-theme-menu
# ======================================================================================

# First, check if Rofi is running. If it is, kill it and exit.
if pgrep -x rofi >/dev/null; then
    pkill -x rofi
    exit 0
fi

# Show Rofi menu
selection=$(uwsm app -- rofi -show themes -modi "themes:${HOME}/.local/anarchy/bin/list-themes" \
             -markup-rows \
             -theme-str 'element { children: [element-text]; } inputbar {  enabled: false; } window { width: 250; }')

# Remove any Pango markup before converting back to filename
clean_selection=$(echo "$selection" | sed -E 's/<[^>]+>//g')

# Convert to lowercase and dash-separated: "Tokyo Night" -> "tokyo-night"
selected_theme=$(echo "$clean_selection" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

# Apply the selected theme only if the variable is not empty and the directory exists (prevents errors hitting esc on keyboard) 
if [ -n "${selected_theme}" ] && [ -d "${THEMES_DIR}/${selected_theme}" ]; then
  "$HOME/.local/share/anarchy/bin/set-theme" "${THEMES_DIR}/${selected_theme}"
fi