#!/bin/bash

# Original reference https://github.com/basecamp/omarchy/blob/dev/bin/omarchy-theme-set
# ======================================================================================
# Based on Omarchy script: omarchy-theme-set
# ======================================================================================

# Usage: set-theme <theme-path>

if [[ -z "$1" ]]; then
  echo "Usage: set-theme <theme-path>" >&2
  exit 1
fi

# A simple grep/sed parser for the key-value pairs in theme.toml
# Usage: get_toml_value <file> <key>
get_toml_value() {
  local file="$1"
  local key="$2"
  # Grep for the key, then use sed to remove the key, equals sign, spaces, and quotes.
  grep -iE "^${key}.*=.*$" "${file}" | sed -e 's/.*=\s*"//g' -e 's/"$//g'
}

THEME_PATH="$1"
if [[ ! -d "${THEME_PATH}" ]]; then
  notify-send -u critical "Theme '${THEME_PATH}' does not exist"
  exit 2
fi

THEME_CONFIG="${THEME_PATH}/theme.toml"
if [[ ! -f "${THEME_CONFIG}" ]]; then
  notify-send -u critical "Theme config file '${THEME_CONFIG}' does not exist"
  exit 3
fi

THEME_NAME=$(get_toml_value "${THEME_CONFIG}" "name")
ICON_THEME=$(get_toml_value "${THEME_CONFIG}" "icon_theme")
ACCENT_COLOR=$(get_toml_value "${THEME_CONFIG}" "accent_color")
VARIANT=$(get_toml_value "${THEME_CONFIG}" "variant")
# Validate that we got the values
if [ -z "$THEME_NAME" ] || [ -z "$ICON_THEME" ] || [ -z "$ACCENT_COLOR" ] || [ -z "$VARIANT" ]; then
  notify-send -u critical "❌ Error: Could not parse all required settings from ${THEME_CONFIG}." "Ensure 'name', 'icon_theme', 'accent_color', and 'dark' are set."
  exit 4
fi

echo "--- Setting the new theme: ${THEME_NAME} ---"
# Update symlinks for the new theme
CURRENT_THEME_DIR="${HOME}/.config/anarchy/theme"
for file in "${THEME_PATH}"/*; do
  # This check prevents errors if the source directory is empty
  [ -e "$file" ] || [ -L "$file" ] || continue
  # Create a symbolic link for each file in the destination directory
  ln -snf "$file" "${CURRENT_THEME_DIR}"
done

# Determine GTK theme and color scheme based on the 'dark' setting
if [ "${VARIANT}" == "dark" ]; then
    GTK_THEME="adw-gtk3-dark"
    COLOR_SCHEME="prefer-dark"
else
    GTK_THEME="adw-gtk3"
    COLOR_SCHEME="default"
fi

# Apply settings using gsettings
gsettings set org.gnome.desktop.interface gtk-theme "${GTK_THEME}"
gsettings set org.gnome.desktop.interface color-scheme "${COLOR_SCHEME}"
gsettings set org.gnome.desktop.interface icon-theme "${ICON_THEME}"
gsettings set org.gnome.desktop.interface accent-color "${ACCENT_COLOR}"

# Set new background
"$HOME/.local/share/anarchy/bin/next-background"

# Trigger alacritty config reload
touch "$HOME/.config/alacritty/alacritty.toml"

# Restart components to apply new theme
pkill -SIGUSR2 btop
pkill -SIGUSR2 waybar
pkill swayosd-server
setsid uwsm app -- swayosd-server &>/dev/null &
makoctl reload
hyprctl reload

# Notify of the new theme
notify-send "✅ Theme changed to $THEME_NAME" -t 2000