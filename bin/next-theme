#!/bin/bash

# Original reference https://github.com/basecamp/omarchy/blob/dev/bin/omarchy-theme-next
# ======================================================================================
# Based on Omarchy script: omarchy-theme-next
# ======================================================================================
THEMES_DIR="$HOME/.local/share/anarchy/themes/"
CURRENT_THEME_DIR="$HOME/.config/anarchy/theme"
CURRENT_THEME_CONFIG="$CURRENT_THEME_DIR/theme.toml"

mapfile -t THEMES < <(find "${THEMES_DIR}" -mindepth 2 -maxdepth 2 -type f -name "theme.toml" -exec dirname {} \; | sort)
TOTAL=${#THEMES[@]}

if [ "$TOTAL" -eq 0 ]; then
  notify-send -u critical "âŒ No valid themes found in ${THEMES_DIR}"
  exit 1
fi

get_theme_name() {
  local config_file=$1
  grep -iE "^name.*=.*$" "${config_file}" | sed -e 's/.*=\s*"//g' -e 's/"$//g'
}

CURRENT_THEME=""
if [ -f "${CURRENT_THEME_CONFIG}" ]; then
  CURRENT_THEME=$(get_theme_name "${CURRENT_THEME_CONFIG}")
fi

# Find current theme index
INDEX=-1
for i in "${!THEMES[@]}"; do
  THIS_THEME=$(get_theme_name "${THEMES[$i]}/theme.toml" )
  if [[ "${THIS_THEME}" == "${CURRENT_THEME}" ]]; then
    INDEX=$i
    break
  fi
done

# Get next theme (wrap around)
NEXT_INDEX=$(((INDEX + 1) % TOTAL))
NEW_THEME=${THEMES[$NEXT_INDEX]}
"$HOME/.local/share/anarchy/bin/set-theme" "${NEW_THEME}"